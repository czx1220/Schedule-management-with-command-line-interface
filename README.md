# 设计文档
## 模块与类设计

本程序分成两个主要模块和一个辅助模块。两个主要模块中account进行账户判断，tasksave进行对任务的操作。辅助模块mainstruct中的函数用于读取输入和打印帮助等操作。
 
Account.h中定义了用户结构体namepwd，包含类型为字符串数组的账户名称以及已哈希加密过的整型变量密码。同时声明了与账户模块有关的函数，主要有哈希加密算法函数SDBMHash、读取输入的用户名与密码的函数ReadInput、防止用户名重复的函数AvoidRepetition、检测用户名与密码是否正确的函数TestAccount和用户模块的主函数Part1Account。

![](https://notes.sjtu.edu.cn/uploads/upload_65cf1e2690172860996ba8e33706a804.png)

tasksave.h中定义了任务结构体task，包含变量id、优先级level、分类、任务名称、是否提醒、嵌套了tm结构体任务时间和提醒时间。声明了与任务操作模块有关的函数如时间打印对齐函数add0，与日期时间有关的函数TestDate、PresentTime、ReceiveTime，提醒函数Remind以及与任务操作有关的ShowTask、

![](https://notes.sjtu.edu.cn/uploads/upload_21e0534ce4d129f993a4d087a61c9a9b.png)
![](https://notes.sjtu.edu.cn/uploads/upload_61bf66d63749f95e1ae176b3759cf5ae.png)
AddTask、DeleteTask、AdjustTask函数等。

Mainstruct.h中声明了打印帮助、读取输入与计算长度等函数。
![](https://notes.sjtu.edu.cn/uploads/upload_b1b405baacb135403489dc7591125e2d.png)

### 流程图
![](https://notes.sjtu.edu.cn/uploads/upload_cfb52a4271bff0ed3548ca1f102c04ac.png)

### 关键技术问题说明
1. 读取内容
本程序对所有输入由键盘输入的内容都采用从第一个不为空格的字符读到最后一个不为空格的字符，也就是输入命令或者命名文件、输入密码时，最前面的空格与最后的空格都不会被读取，而在中间内部的空格则会被读取。为了达到这一点，考虑首先用fgets(put,n,stdin)读取输入后再进行处理，去掉前面和后面的空格并在最后补上'\0'，并用setbuf(stdin , NULL)清空缓冲区。由于fflush(stdin)仅适用于Windows，在linux中不起作用，故采用 setbuf( stdin , NULL)。在判断输入内容时，对于字符串采用strcmp，由于空字符串和非数字字符串atoi的返回值也为0，故设计一个函数使空字符串和非数字字符串返回值为-1，再与atoi结合。如果输入的东西无效，则打印“invalid input”。
对于从文件中读取的内容，由于依旧使用fgets(put,n,stdin)进行读取，故文件结尾存在‘\n’，将其转为‘\0’后再进行后续操作。

2. 任务文件
本程序采用的方法是在程序开始时把任务从文件中读取到结构体数组中，任何操作都首先对结构体数组进行，并且在进行任何改动后都用新的结构体数组去覆盖原文件的内容，每次循环都重新读取原文件的内容。

3. 任务提醒
在用新的结构体数组去覆盖原文件的内容之前，首先根据任务的提醒时间对任务进行排序，这样与现在的时间进行比较时只要比较前几个任务的时间而不需要比较所有任务的时间。
同时对每个任务都添加一个是否需要提醒的标识符，程序新启动时，所有任务的这个标识符都为1，在提醒过一次后，这个标识符变为0，即不再进行提醒。如果关掉程序后重新打开，这个标识符重新变为1。对新添的任务和进行修改过的任务，这个标识符变为1。
对任务的提醒做如下约定：如果现在时间已经超过提醒时间，且未超过任务时间或提醒时间一天，并且在程序启动后还未提醒过，则进行提醒。

4. 线程
在账户成功登陆后，创建线程，一个根据指令对文件进行操作，一个检测任务是否到时并进行提醒。
由于检测任务是否到时的线程不会对任务在文件中保存的内容进行改动，即所有对文件中任务的改动都是由于第一个线程，故可将所有有关任务从文件中读取的操作都放在第一个线程中，第二个线程只对结构体数组进行操作而不涉及对文件的操作。

5. 上锁与解锁
利用pthread.h中的互斥锁函数pthread_mutex_lock（unlock）给锁mutex0进行加锁（解锁），防止共享数据被更改。